<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mourish AI - AI Code & Chat Studio</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles for a Dark, Professional Look */
        :root {
            --primary-color: #06b6d4; /* Default Teal */
            --accent-glow: 0 0 15px rgba(6, 182, 212, 0.7);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Deep Navy Blue Background */
        }
        .ai-card {
            background-color: #272747; /* Slightly lighter card background */
            border: 1px solid #3a3a5a;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .btn-primary {
            background-color: var(--primary-color);
            transition: all 0.2s;
        }
        .btn-primary:hover {
            box-shadow: var(--accent-glow);
            filter: brightness(1.1);
        }
        .code-editor {
            background-color: #1e1e3f; /* VSCode-like editor dark background */
            color: #d4d4d4;
            border: 1px solid #3a3a5a;
            white-space: pre-wrap; /* Preserve formatting */
        }
        .console-output {
            background-color: #15152a; /* Console background */
            color: #ccc;
            border-left: 4px solid var(--primary-color);
            height: 400px; /* Adjusted height */
        }
        .console-success {
            color: #34d399; /* Green for success */
        }
        .console-step {
            color: var(--primary-color);
        }

        /* Chat Specific Styles */
        .chat-user {
            background-color: #3a3a5a; /* User bubble */
            color: #fff;
            padding: 6px 10px;
            border-radius: 12px 12px 0 12px;
            margin: 5px 0;
            max-width: 90%;
            align-self: flex-end;
        }
        .chat-ai {
            background-color: #1e1e3f; /* AI bubble */
            color: #d4d4d4;
            padding: 6px 10px;
            border-radius: 12px 12px 12px 0;
            margin: 5px 0;
            max-width: 90%;
            align-self: flex-start;
        }
        /* Ensure responsive grid layout */
        @media (min-width: 1024px) {
            .output-grid {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        /* --- CUSTOM LOADER STYLES --- */
        .custom-loader {
            width: 50px;
            height: 50px;
            position: relative;
            transform: rotate(45deg); 
        }

        .loader-shape {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            background-color: var(--primary-color);
            animation: 
                loader-rotate 2s infinite linear,
                loader-pulse 1.5s infinite alternate;
            box-shadow: var(--accent-glow);
        }

        @keyframes loader-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes loader-pulse {
            0% { transform: scale(0.7); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.7); opacity: 0.8; }
        }
        /* --- END CUSTOM LOADER STYLES --- */

        /* Live Preview Container Styles */
        .preview-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobile Mockup Frame Style */
        .mockup-frame {
            /* This class is toggled by JS to constrain the viewport */
            width: 80%;
            max-width: 300px;
            height: 100%;
            max-height: 550px;
            background-color: #333;
            border: 10px solid #222;
            border-radius: 40px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5), inset 0 0 5px rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }
        
        .mockup-frame iframe {
            border-radius: 30px; /* Inner radius to match frame */
        }
        
        /* Desktop View: Full width/height, no frame */
        .desktop-view {
            width: 100%;
            height: 100%;
            transition: all 0.3s ease-in-out;
        }
        
        .desktop-view iframe {
            border-radius: 0;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex items-center justify-center">

    <div id="app" class="w-full max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-white mb-2 tracking-tight">
                Mourish <span style="color: var(--primary-color);">AI</span>
            </h1>
            <p class="text-lg text-gray-400">The Autonomous Code & Chat Studio (Using localStorage).</p>
        </header>

        <!-- Main Card Container (Responsive and Centered) -->
        <div class="ai-card p-6 md:p-10 rounded-xl">

            <!-- Stage 1: Initial Prompt Input -->
            <div id="stage-1-prompt">
                <h2 class="text-2xl font-semibold text-white mb-4">Step 1: Define Your Vision</h2>
                <p class="text-gray-400 mb-6">Describe the application or website you want to build. The AI will generate the single-file code.</p>

                <textarea id="app-prompt" rows="8" class="w-full p-4 rounded-lg code-editor focus:ring-2 focus:ring-teal-400 outline-none" placeholder="E.g., A minimalist responsive blog homepage for a travel company. Use a dark theme, Tailwind CSS, and include a large hero image placeholder."></textarea>
                
                <button onclick="nextStage()" class="btn-primary w-full py-3 mt-6 text-white font-bold rounded-lg shadow-lg">
                    Configure & Generate
                </button>
            </div>

            <!-- Stage 2: Detail Collection -->
            <div id="stage-2-details" class="hidden">
                <h2 class="text-2xl font-semibold text-white mb-4">Step 2: Branding & Configuration</h2>
                <p class="text-gray-400 mb-6">Specify the target environment and primary style choices.</p>

                <div class="space-y-4">
                    <!-- Project Type Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Target Output Type</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center text-white cursor-pointer">
                                <input type="radio" name="project-type" value="website" checked onclick="setProjectType('website')" class="form-radio h-4 w-4 text-teal-500 border-gray-600 bg-gray-600 focus:ring-teal-500">
                                <span class="ml-2">Website (HTML/Tailwind)</span>
                            </label>
                            <label class="inline-flex items-center text-white cursor-pointer">
                                <input type="radio" name="project-type" value="app" onclick="setProjectType('app')" class="form-radio h-4 w-4 text-teal-500 border-gray-600 bg-gray-600 focus:ring-teal-500">
                                <span class="ml-2">Mobile App (React Native/JSX)</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label for="app-name-input" class="block text-sm font-medium text-gray-300 mb-1">Application Name</label>
                        <input type="text" id="app-name-input" value="Mourish Project" class="w-full p-3 rounded-lg code-editor focus:ring-2 focus:ring-teal-400 outline-none">
                    </div>
                    <div>
                        <label for="primary-color-input" class="block text-sm font-medium text-gray-300 mb-1">Primary Color (HEX)</label>
                        <div class="flex items-center space-x-3">
                            <input type="color" id="color-picker" value="#06b6d4" onchange="updateColorInput(this.value)" class="h-10 w-10 p-0 rounded-lg border-none cursor-pointer">
                            <input type="text" id="primary-color-input" value="#06b6d4" oninput="updateColorPicker(this.value)" class="flex-grow p-3 rounded-lg code-editor focus:ring-2 focus:ring-teal-400 outline-none placeholder-gray-500" placeholder="#RRGGBB">
                        </div>
                    </div>
                </div>
                
                <button onclick="startGeneration()" class="btn-primary w-full py-3 mt-6 text-white font-bold rounded-lg shadow-lg" id="generate-button">
                    Start Code Generation & Preview
                </button>
            </div>

            <!-- Stage 3: Generation & Output -->
            <div id="stage-3-output" class="hidden">
                <h2 class="text-2xl font-semibold text-white mb-6">Step 3: Code, Chat & Live Preview</h2>

                <!-- Output Grid: Code Editor & Console -->
                <div class="output-grid grid grid-cols-1 lg:grid-cols-3 gap-6">

                    <!-- Output Area (2/3 width on desktop) -->
                    <div class="lg:col-span-2">
                         <!-- Tab Navigation -->
                        <div class="flex border-b border-gray-600 mb-2">
                            <button id="tab-code" onclick="showOutputTab('code')" class="px-4 py-2 text-sm font-medium text-white border-b-2 border-teal-400 focus:outline-none">Code Editor</button>
                            <button id="tab-preview" onclick="showOutputTab('preview')" class="px-4 py-2 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-400 focus:outline-none">Live Preview</button>
                        </div>

                        <!-- Tab Content -->
                        <div id="content-code" class="relative">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-400">Generated Code (<span id="code-language">HTML</span>)</span>
                                <button id="copy-button" onclick="copyCode()" class="px-3 py-1 text-xs text-white bg-green-600 hover:bg-green-700 rounded-full transition duration-150 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-2-4l-4 4-4-4m4 4V7"></path></svg>
                                    <span id="copy-text">Copy Code</span>
                                </button>
                            </div>
                            <textarea id="generated-code" class="w-full h-96 p-4 rounded-lg code-editor resize-none text-sm leading-relaxed" readonly placeholder="Waiting for Mourish AI (Gemini 2.5) to generate code..."></textarea>
                        </div>
                        
                        <div id="content-preview" class="hidden h-96">
                             <!-- Viewport Controls -->
                            <div class="flex space-x-3 mb-2">
                                <button id="mode-desktop" onclick="setPreviewMode('desktop')" class="px-3 py-1 text-xs text-white bg-teal-600 rounded-full transition duration-150">Desktop View</button>
                                <button id="mode-mobile" onclick="setPreviewMode('mobile')" class="px-3 py-1 text-xs text-gray-400 bg-gray-600 hover:bg-gray-700 rounded-full transition duration-150">Mobile View</button>
                            </div>
                            <!-- Live Preview Iframe Container -->
                            <div id="preview-container" class="preview-container desktop-view h-full">
                                <iframe id="live-preview-iframe" src="about:blank" class="w-full h-full border-none bg-white rounded-lg"></iframe>
                            </div>
                        </div>
                    </div>

                    <!-- Console & Chat (1/3 width on desktop) -->
                    <div class="lg:col-span-1">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-400">Mourish AI Console & Chat (localStorage)</span>
                        </div>
                        <div id="app-console" class="console-output p-4 rounded-lg text-xs overflow-y-auto flex flex-col items-start space-y-2">
                            <!-- Console and Chat history loaded here -->
                        </div>
                        
                        <!-- Chat Input -->
                        <div id="chat-input-container" class="mt-4 flex">
                            <input type="text" id="chat-input" placeholder="Ask the AI about your design..." class="flex-grow p-3 rounded-l-lg code-editor focus:ring-2 focus:ring-teal-400 outline-none text-sm" onkeydown="if(event.key==='Enter') handleChatSubmit()">
                            <button onclick="handleChatSubmit()" id="chat-send-btn" class="btn-primary px-4 py-3 text-white font-bold rounded-r-lg shadow-lg flex items-center justify-center disabled:opacity-50" disabled>
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </button>
                        </div>
                         <div id="chat-loading-spinner" class="hidden text-center p-2">
                            <div class="custom-loader w-6 h-6 mx-auto"><div class="loader-shape"></div></div>
                         </div>
                    </div>

                </div>
                
                <!-- Back Button -->
                <button onclick="resetApp()" class="mt-6 text-gray-400 hover:text-white transition duration-150 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Start New Project (Clears History)
                </button>
            </div>

            <!-- Global Loading Spinner -->
            <div id="loading-spinner" class="hidden text-center p-10">
                <div class="flex flex-col items-center justify-center">
                    <div class="custom-loader mb-4">
                        <div class="loader-shape"></div>
                    </div>
                    
                    <p class="mt-4 text-white text-lg font-medium" id="global-loading-message">Mourish AI (Gemini 2.5) is generating code...</p>
                    <p class="text-sm text-gray-500">This may take a moment while the AI architects your application.</p>
                </div>
            </div>

        </div>

    </div>

    <script type="module">
        // Global variables and configuration
        // User's provided API key is hardcoded here:
        const API_KEY = "AIzaSyAb7kOJj9_YEc_oC48bhAXpLaKRJOZt41M"; 
        const CODE_CHAT_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";

        let isChatting = false; // Prevents multiple simultaneous chat responses
        let currentPreviewMode = 'desktop'; // New state for preview mode
        
        let appState = {
            prompt: "",
            appName: "Mourish Project",
            primaryColor: "#06b6d4",
            projectType: "website",
            generatedCode: ""
        };
        
        let chatHistory = []; // Stores history in Gemini format

        const elements = {
            stage1: document.getElementById('stage-1-prompt'),
            stage2: document.getElementById('stage-2-details'),
            stage3: document.getElementById('stage-3-output'),
            loading: document.getElementById('loading-spinner'),
            chatLoading: document.getElementById('chat-loading-spinner'),
            codeEditor: document.getElementById('generated-code'),
            console: document.getElementById('app-console'),
            colorPicker: document.getElementById('color-picker'),
            colorInput: document.getElementById('primary-color-input'),
            appPrompt: document.getElementById('app-prompt'),
            appNameInput: document.getElementById('app-name-input'),
            copyButton: document.getElementById('copy-button'),
            copyText: document.getElementById('copy-text'),
            root: document.documentElement,
            
            // UI elements
            tabCode: document.getElementById('tab-code'),
            tabPreview: document.getElementById('tab-preview'),
            contentCode: document.getElementById('content-code'),
            contentPreview: document.getElementById('content-preview'),
            previewIframe: document.getElementById('live-preview-iframe'),
            globalLoadingMessage: document.getElementById('global-loading-message'),

            chatInput: document.getElementById('chat-input'),
            chatSendBtn: document.getElementById('chat-send-btn'),
            
            // New elements for preview control
            previewContainer: document.getElementById('preview-container'),
            modeDesktopBtn: document.getElementById('mode-desktop'),
            modeMobileBtn: document.getElementById('mode-mobile'),
        };
        
        // --- LocalStorage Persistence ---

        function saveState() {
            localStorage.setItem('mourishAppState', JSON.stringify({
                appState: appState,
                chatHistory: chatHistory,
                generatedCode: elements.codeEditor.value,
                previewMode: currentPreviewMode
            }));
        }

        function loadState() {
            const stored = localStorage.getItem('mourishAppState');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    
                    appState = data.appState || appState;
                    // Filter out any potential non-array/empty history
                    chatHistory = Array.isArray(data.chatHistory) ? data.chatHistory : [];
                    appState.generatedCode = data.generatedCode || '';
                    currentPreviewMode = data.previewMode || 'desktop';

                } catch (e) {
                    console.error("Error loading state from localStorage:", e);
                    localStorage.removeItem('mourishAppState');
                }
            }
        }
        
        function renderChatHistory() {
            elements.console.innerHTML = '';
            
            // Render initial static message
            elements.console.innerHTML += `
                <p class="console-step initial-message">> Initializing Mourish AI...</p>
                <p class="initial-message">> Ready for code generation (Step 1). Chat history is loaded from localStorage.</p>
            `;

            chatHistory.forEach(msg => {
                const p = document.createElement('div');
                const text = msg.parts[0].text || '';
                
                // Render system logs directly as HTML
                if (msg.role === 'system_log') {
                    p.innerHTML = text;
                } else if (msg.role === 'user') {
                    p.className = 'chat-user text-wrap break-words';
                    p.textContent = text;
                    p.style.alignSelf = 'flex-end';
                } else if (msg.role === 'model') {
                    p.className = 'chat-ai text-wrap break-words';
                    p.textContent = text;
                    p.style.alignSelf = 'flex-start';
                }
                
                if (msg.role !== 'system_log') {
                   elements.console.appendChild(p);
                }
            });
            elements.console.scrollTop = elements.console.scrollHeight;
        }


        // --- Chat & Console Messaging ---

        /** Performs a character-by-character typing animation on an element. */
        function typeMessage(element, text) {
            return new Promise(resolve => {
                let i = 0;
                element.innerHTML = ''; 

                const interval = setInterval(() => {
                    if (i < text.length) {
                        element.innerHTML += text.charAt(i);
                        i++;
                        elements.console.scrollTop = elements.console.scrollHeight; 
                    } else {
                        clearInterval(interval);
                        resolve();
                    }
                }, 15);
            });
        }
        
        /** Appends a message (system log, user chat, or AI chat) to the console AND saves it to localStorage. */
        async function appendMessage(text, role, isSystem = false) {
            const consoleDiv = elements.console;

            let elementClass = '';
            let elementTag = 'div'; 
            let chatRole = role; // user or model

            if (isSystem) {
                // System messages are HTML-formatted and appended directly
                const messageElement = document.createElement(elementTag);
                messageElement.innerHTML = text;
                consoleDiv.appendChild(messageElement.firstChild);
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
                
                // Save system logs to history for reload consistency
                chatHistory.push({ role: 'system_log', parts: [{ text: text }] });
                saveState();
                return;
            }

            // Chat messages
            if (role === 'user') {
                elementClass = 'chat-user';
            } else if (role === 'model') {
                elementClass = 'chat-ai';
            }
            
            const messageElement = document.createElement(elementTag);
            messageElement.className = elementClass + ' text-wrap break-words';
            messageElement.style.margin = '5px 0'; 
            messageElement.style.maxWidth = '90%';
            messageElement.style.alignSelf = role === 'user' ? 'flex-end' : 'flex-start';

            // 2. Append to console and start typing
            consoleDiv.appendChild(messageElement);
            await typeMessage(messageElement, text);

            // 3. Save to chat history and localStorage
            chatHistory.push({
                role: chatRole,
                parts: [{ text: text.trim() }]
            });
            saveState();
        }
        
        // --- Chat Functionality ---

        window.handleChatSubmit = async function() {
            const query = elements.chatInput.value.trim();
            if (!query || isChatting) return;

            elements.chatInput.value = ''; 
            isChatting = true;
            elements.chatSendBtn.disabled = true;
            elements.chatLoading.classList.remove('hidden');

            try {
                await appendMessage(query, 'user', false);
                
                const aiResponse = await callGeminiChatAPI(query);
                
                await appendMessage(aiResponse, 'model', false);

            } catch (error) {
                appendMessage(`<p class="text-red-500">AI Chat Error: Failed to get response. ${error.message}</p>`, true);
            } finally {
                isChatting = false;
                elements.chatSendBtn.disabled = false;
                elements.chatLoading.classList.add('hidden');
            }
        }

        async function callGeminiChatAPI(query) {
            const currentCode = elements.codeEditor.value || 'No code generated yet.';
            const currentPrompt = appState.prompt || 'No initial prompt provided.';

            const systemInstruction = `You are Mourish AI, a helpful, world-class design and coding assistant. 
            The user is building a project with the initial goal: "${currentPrompt}". 
            The current generated code is:
            ---
            ${currentCode.substring(0, 1000)}... (truncated)
            ---
            Answer the user's question concisely, using Markdown formatting where appropriate.`;

            // Prepare history, excluding system logs
            const historyForApi = chatHistory.filter(msg => msg.role === 'user' || msg.role === 'model');
            
            // Add current user query to the payload
            historyForApi.push({ role: 'user', parts: [{ text: query }] });
            

            const payload = {
                contents: historyForApi,
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                }
            };

            const responseText = await fetchAPI(CODE_CHAT_API_URL, payload, 'code_chat');
            // Remove the user query we temporarily added for the API call from the real history
            historyForApi.pop(); 
            return responseText;
        }

        // --- Core UI & State Management ---
        
        window.setPreviewMode = function(mode) {
            currentPreviewMode = mode;
            const container = elements.previewContainer;
            const iframe = elements.previewIframe;
            const desktopBtn = elements.modeDesktopBtn;
            const mobileBtn = elements.modeMobileBtn;
            const isMobile = mode === 'mobile';
            
            // 1. Update Container classes
            container.classList.toggle('desktop-view', !isMobile);
            container.classList.toggle('mockup-frame', isMobile && appState.projectType === 'website');

            // 2. Update Iframe classes (controlled by parent container, but ensure consistent style)
            iframe.style.borderRadius = isMobile && appState.projectType === 'website' ? '30px' : '0';

            // 3. Update Button Styles
            desktopBtn.classList.toggle('bg-teal-600', !isMobile);
            desktopBtn.classList.toggle('bg-gray-600', isMobile);
            desktopBtn.classList.toggle('text-white', !isMobile);
            desktopBtn.classList.toggle('text-gray-400', isMobile);
            desktopBtn.classList.toggle('hover:bg-gray-700', isMobile);
            
            mobileBtn.classList.toggle('bg-teal-600', isMobile);
            mobileBtn.classList.toggle('bg-gray-600', !isMobile);
            mobileBtn.classList.toggle('text-white', isMobile);
            mobileBtn.classList.toggle('text-gray-400', !isMobile);
            mobileBtn.classList.toggle('hover:bg-gray-700', !isMobile);

            // Re-render content if it was an app preview (to update visualization message)
            if (appState.projectType === 'app') {
                updatePreview();
            }
            
            saveState();
        }

        window.setProjectType = function(type) {
            appState.projectType = type;
            saveState();
        }

        window.updateColorInput = function(value) {
            elements.colorInput.value = value;
            updatePrimaryColor(value);
            saveState();
        }

        window.updateColorPicker = function(value) {
            elements.colorPicker.value = value;
            updatePrimaryColor(value);
            saveState();
        }

        function updatePrimaryColor(hex) {
            if (/^#[0-9A-F]{6}$/i.test(hex)) {
                elements.root.style.setProperty('--primary-color', hex);
                appState.primaryColor = hex;
            }
        }

        window.nextStage = function() {
            const promptValue = elements.appPrompt.value.trim();
            if (promptValue.length < 20) {
                alertUser("Please provide a more detailed description (at least 20 characters).", "error");
                return;
            }
            appState.prompt = promptValue;
            elements.stage1.classList.add('hidden');
            elements.stage2.classList.remove('hidden');
            if (elements.appNameInput.value === "Mourish Project" || !elements.appNameInput.value) {
                const suggestedName = appState.prompt.split(/\s+/).slice(0, 3).join(' ') + " Project";
                elements.appNameInput.value = suggestedName;
                appState.appName = suggestedName;
            }
            saveState();
            appendMessage('<p>User details defined. Proceeding to configuration.</p>', true);
        }

        window.showOutputTab = function(tab) {
            [elements.tabCode, elements.tabPreview].forEach(btn => {
                btn.classList.remove('border-teal-400', 'text-white');
                btn.classList.add('border-transparent', 'text-gray-400', 'hover:border-gray-400');
            });
            
            const activeTab = {
                'code': elements.tabCode,
                'preview': elements.tabPreview,
            }[tab];

            activeTab.classList.add('border-teal-400', 'text-white');
            activeTab.classList.remove('border-transparent', 'text-gray-400', 'hover:border-gray-400');
            
            elements.contentCode.classList.toggle('hidden', tab !== 'code');
            elements.contentPreview.classList.toggle('hidden', tab !== 'preview');
            
            if (tab === 'preview') {
                // Set the mode based on the last saved state when the tab is opened
                setPreviewMode(currentPreviewMode);
                updatePreview();
            }
        }
        
        function generateMockupHtml() {
            // This is used for React Native projects, as they cannot run in an iframe.
             const frameStyle = currentPreviewMode === 'mobile' ? 'max-width: 80%;' : 'max-width: 100%;';

             return `
                <div style="background-color: #fff; height: 100%; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 16px; font-family: sans-serif; box-sizing: border-box; color: #333;">
                    <svg class="w-10 h-10 text-teal-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                    <p style="font-size: 14px; font-weight: bold; text-align: center; color: ${appState.primaryColor};">${appState.appName} (Mobile App)</p>
                    <p style="font-size: 12px; color: #666; text-align: center; margin-top: 5px;">This is a conceptual visualization of the generated React Native code's layout in ${currentPreviewMode} mode.</p>
                    <div style="margin-top: 15px; padding: 10px; border: 1px dashed #ddd; width: 80%; text-align: center; background-color: #f9f9f9; border-radius: 8px;">
                        <p style="font-size: 10px; color: #999;">React Native Code (JSX) Generated</p>
                    </div>
                </div>
             `;
        }

        function updatePreview() {
            const code = elements.codeEditor.value;
            const iframe = elements.previewIframe;
            
            if (!code) {
                 alertUser("No code generated to preview. Click the 'Start Code Generation' button first.", "error");
                 return;
            }

            if (appState.projectType === 'website') {
                // Inject the HTML directly
                iframe.contentWindow.document.open();
                iframe.contentWindow.document.write(code);
                iframe.contentWindow.document.close();
                appendMessage(`<p class="console-step">> Website Preview loaded successfully (mode: ${currentPreviewMode}).</p>`, true);
            } else { // Mobile App (React Native/JSX)
                 // Inject the conceptual mockup for App/JSX code
                 const mockupHtml = generateMockupHtml();
                 iframe.contentWindow.document.open();
                 iframe.contentWindow.document.write(mockupHtml);
                 iframe.contentWindow.document.close();
                 appendMessage(`<p class="console-step">> Mobile App conceptual preview loaded. (Code is for native compilation.)</p>`, true);
            }
        }
        
        window.startGeneration = async function() {
            appState.appName = elements.appNameInput.value.trim() || "Generated App";
            appState.primaryColor = elements.colorInput.value.trim() || "#06b6d4";

            if (!appState.appName) {
                alertUser("Please enter an Application Name.", "error");
                return;
            }

            elements.stage2.classList.add('hidden');
            elements.stage3.classList.remove('hidden');
            elements.globalLoadingMessage.textContent = 'Mourish AI (Gemini 2.5) is generating code...';
            elements.loading.classList.remove('hidden');
            elements.codeEditor.value = "";
            
            saveState(); // Save state before starting generation

            appendMessage(`> Configuration complete: Name='${appState.appName}', Color='${appState.primaryColor}', Type='${appState.projectType}'`, true);
            appendMessage(`> Mourish AI initiating code generation...`, true);

            try {
                const generatedCode = await callGeminiCodeAPI(appState.prompt, appState.appName, appState.primaryColor, appState.projectType);
                
                elements.codeEditor.value = generatedCode.trim();
                elements.codeEditor.scrollTop = 0;
                
                appState.generatedCode = elements.codeEditor.value;
                saveState(); // Save the generated code
                
                appendMessage(`<p class="console-success">> Generation complete (100%). Code validated.</p>`, true);
                appendMessage(`<p class="console-step">> To see your website/app, click the "Live Preview" tab above the code editor.</p>`, true);
                appendMessage(`<p>Code is ready. Feel free to chat below or check the Live Preview tab.</p>`, true);
                elements.chatSendBtn.disabled = false;
                
            } catch (error) {
                elements.codeEditor.value = `Error generating code. Please try again with a simpler prompt.\nDetails: ${error.message}`;
                appendMessage(`<p class="text-red-500">> ERROR: Failed to generate code. Check console for details.</p>`, true);
                console.error("Gemini API Code Error:", error);
            } finally {
                elements.loading.classList.add('hidden');
            }
        }

        window.resetApp = function() {
            // Clear localStorage
            localStorage.removeItem('mourishAppState');
            
            // Reset local state to defaults
            appState = { 
                prompt: "", 
                appName: "Mourish Project", 
                primaryColor: "#06b6d4", 
                projectType: "website", 
                generatedCode: "" 
            };
            chatHistory = [];
            currentPreviewMode = 'desktop';
            
            // Reset UI
            elements.stage3.classList.add('hidden');
            elements.stage1.classList.remove('hidden');
            elements.appPrompt.value = '';
            elements.appNameInput.value = 'Mourish Project';
            elements.colorInput.value = '#06b6d4';
            elements.colorPicker.value = '#06b6d4';
            document.querySelector('input[name="project-type"][value="website"]').checked = true;
            updatePrimaryColor('#06b6d4');
            elements.codeEditor.value = '';
            elements.chatInput.value = '';
            elements.console.innerHTML = '';
            elements.chatSendBtn.disabled = true;

            appendMessage('<p class="console-success">> Project reset. Start a new vision!</p>', true);

            elements.copyText.textContent = 'Copy Code';
            showOutputTab('code'); 
        }

        function alertUser(message, type) {
            const color = type === 'error' ? 'text-red-500' : 'text-yellow-500';
            appendMessage(`<p class="${color}">> ALERT: ${message}</p>`, true);
            console.warn("User Alert:", message);
        }

        // --- Core Functionality (Gemini API Call for CODE GENERATION) ---

        async function callGeminiCodeAPI(prompt, appName, primaryColor, projectType) {
            const outputType = projectType === 'website' ? 
                'single-file HTML application (with embedded Tailwind CSS and JavaScript)' : 
                'single-file JSX/TypeScript (React Native/Expo) component';

            const outputInstruction = projectType === 'website' ? 
                "Output ONLY the raw HTML code block (starting with <!DOCTYPE html> and ending with </html>). Do not wrap the code in markdown fences." :
                "Output ONLY the raw JSX/TSX code block for a single React Native component (starting with 'import React' and ending with export default App). Do not wrap the code in markdown fences.";

            const fullPrompt = `Generate a complete, modern, ${outputType} for the following request: "${prompt}".
            
            Key Specifications:
            1. Application Name: ${appName}
            2. Primary Accent Color (HEX): ${primaryColor}
            3. Project Type: ${projectType.toUpperCase()}
            4. Ensure the design is highly responsive and mobile-friendly.
            5. Use the provided primary color for buttons and primary elements.
            
            ${outputInstruction}`;

            const systemInstruction = "You are Mourish AI, a world-class, autonomous coding agent (running on Gemini 2.5). Your task is to generate clean, production-ready, single-file code to fulfill the user's detailed request. The code must be self-contained and immediately runnable (if HTML) or ready for compilation (if App). Focus on high quality, responsive UI, and incorporating the specified branding. Do not include any explanatory text, markdown fences, or comments outside the actual code content.";

            const payload = {
                contents: [{ parts: [{ text: fullPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                }
            };
            
            document.getElementById('code-language').textContent = projectType === 'website' ? 'HTML' : 'React Native (JSX)';

            const text = await fetchAPI(CODE_CHAT_API_URL, payload, 'code');
            // Remove markdown fences if the model erroneously included them
            return text.replace(/```(html|jsx|javascript)\n?|```/gi, '').trim();
        }

        // --- Universal API Fetcher with Backoff ---

        async function fetchAPI(apiUrl, payload, type) {
            const MAX_RETRIES = 5;
            let currentDelay = 1000;
            const finalApiKey = API_KEY; 
            const finalUrl = `${apiUrl}?key=${finalApiKey}`; // API Key appended to URL

            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(finalUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        if (attempt < MAX_RETRIES - 1) {
                            appendMessage(`<p class="text-yellow-500">> API rate limit hit. Retrying in ${currentDelay / 1000}s...</p>`, true);
                            await new Promise(resolve => setTimeout(resolve, currentDelay));
                            currentDelay *= 2; 
                            continue;
                        } else {
                            throw new Error("API rate limit exceeded after multiple retries.");
                        }
                    }

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Full API Error Response (${response.status}):`, errorText);
                        throw new Error(`API returned status ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    // Extract text for code/chat
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        return text.trim();
                    } else {
                        throw new Error("Response was successful but contained no generated text.");
                    }

                } catch (error) {
                    if (attempt < MAX_RETRIES - 1) {
                        console.error(`API error (Attempt ${attempt + 1}). Retrying...`);
                        await new Promise(resolve => setTimeout(resolve, currentDelay));
                        currentDelay *= 2;
                        continue;
                    } else {
                        throw error;
                    }
                }
            }
        }

        window.copyCode = function() {
            const code = elements.codeEditor.value;
            if (!code) {
                alertUser("Nothing to copy.", "error");
                return;
            }
            
            const tempTextArea = document.createElement("textarea");
            tempTextArea.value = code;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    elements.copyText.textContent = 'Copied!';
                } else {
                    alertUser("Copy failed, please select and copy manually.", "error");
                }
            } catch (err) {
                alertUser("Copy failed: browser environment restriction.", "error");
                console.error('Copy error', err);
            }
            
            document.body.removeChild(tempTextArea);
            
            setTimeout(() => {
                elements.copyText.textContent = 'Copy Code';
            }, 2000);
        }

        window.onload = () => {
            loadState();
            
            // Initialize UI from loaded state
            elements.appPrompt.value = appState.prompt;
            elements.appNameInput.value = appState.appName;
            elements.colorInput.value = appState.primaryColor;
            elements.colorPicker.value = appState.primaryColor;
            updatePrimaryColor(appState.primaryColor);
            
            if (appState.projectType === 'app') {
                document.querySelector('input[name="project-type"][value="app"]').checked = true;
            } else {
                document.querySelector('input[name="project-type"][value="website"]').checked = true;
            }
            
            // If code was previously generated, skip to stage 3
            if (appState.generatedCode) {
                elements.stage1.classList.add('hidden');
                elements.stage3.classList.remove('hidden');
                elements.codeEditor.value = appState.generatedCode;
                elements.chatSendBtn.disabled = false;
            }
            
            renderChatHistory(); // Render existing chat history
            
            // Ensure the initial mode is set for button styling
            setPreviewMode(currentPreviewMode);
        };
        
    </script>
</body>
</html>
